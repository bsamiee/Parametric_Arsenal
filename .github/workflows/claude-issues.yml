name: Claude Issue Implementation

on:
  issues:
    types: [labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  implement:
    if: github.event.label.name == 'claude-implement'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Parse Issue Metadata
        id: parse_issue
        uses: actions/github-script@v8
        with:
          script: |
            const body = context.payload.issue.body || '';
            body || core.warning('Issue body is empty, using defaults');
            
            const extractMatch = (regex, fallback) => {
              const match = body.match(regex);
              return match ? match[1].trim() : fallback;
            };
            
            const agent = extractMatch(/### Recommended Agent\s+([^\n]+)/, 'auto-detect');
            const scope = extractMatch(/### Scope\s+([^\n]+)/, 'unknown');
            
            core.setOutput('agent', agent);
            core.setOutput('scope', scope);
            core.info(`Detected agent: ${agent}`);
            core.info(`Detected scope: ${scope}`);

      - name: Load Agent Context
        id: agent_context
        if: steps.parse_issue.outputs.agent != 'auto-detect'
        run: |
          AGENT="${{ steps.parse_issue.outputs.agent }}"
          AGENT_FILE=".github/agents/${AGENT}.agent.md"
          
          if [ -f "$AGENT_FILE" ]; then
            echo "agent_instructions<<EOF" >> $GITHUB_OUTPUT
            cat "$AGENT_FILE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "[INFO] Loaded agent context from $AGENT_FILE"
          else
            echo "agent_instructions=" >> $GITHUB_OUTPUT
            echo "[WARN] Agent file $AGENT_FILE not found, proceeding without agent context"
          fi

      - name: Claude Implement Issue
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: "true"
          prompt: |
            Implement issue #${{ github.event.issue.number }}: "${{ github.event.issue.title }}"

            ## ISSUE DETAILS
            ${{ github.event.issue.body }}

            ${{ steps.agent_context.outputs.agent_instructions && format('## SPECIALIST AGENT CONTEXT\n\n{0}', steps.agent_context.outputs.agent_instructions) || '' }}

            ## IMPLEMENTATION REQUIREMENTS

            1. **Read CLAUDE.md first** - All code must follow these standards exactly
            2. **Study exemplar files** before writing:
               - libs/core/results/Result.cs
               - libs/core/operations/UnifiedOperation.cs
               - libs/rhino/spatial/Spatial.cs

            3. **Code style (build failures)**:
               - NO var - explicit types only
               - NO if/else - ternary, switch expressions, pattern matching
               - Named parameters for non-obvious args
               - Trailing commas on all multi-line collections
               - K&R braces, file-scoped namespaces
               - One type per file

            4. **Architecture**:
               - Result<T> for failable operations
               - UnifiedOperation for polymorphic dispatch
               - E.* errors from libs/core/errors/E.cs
               - V.* validation flags

            5. **Verification**:
               - Run `dotnet build` - must pass with zero warnings
               - Run `dotnet test --collect:"XPlat Code Coverage"` - all tests must pass
               - Add tests for new functionality
               - Coverage for new code must be >80%

            ## DELIVERABLE

            Create a PR that:
            - Implements the requested functionality
            - Passes all CI checks
            - Includes appropriate tests
            - Links to issue #${{ github.event.issue.number }}

            Use: `gh pr create --title "..." --body "Closes #${{ github.event.issue.number }}\n\n..."`

          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 20
          settings: |
            {
              "permissions": {
                "allow": [
                  "Read",
                  "Write",
                  "Edit",
                  "Bash",
                  "Glob",
                  "Grep",
                  "Task",
                  "WebSearch",
                  "mcp__context7__*",
                  "mcp__github__*"
                ]
              },
              "mcpServers": {
                "context7": {
                  "command": "npx",
                  "args": ["-y", "@upstash/context7-mcp"]
                },
                "github": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-github"],
                  "env": {
                    "GITHUB_TOKEN": "${{ github.token }}"
                  }
                }
              }
            }

      - name: Run Tests with Coverage
        id: coverage
        if: success()
        run: |
          dotnet test --collect:"XPlat Code Coverage" --results-directory ./TestResults
          echo "[INFO] Test coverage collected"

      - name: Install Coverage Tools
        if: success()
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils bc

      - name: Check Coverage Threshold
        if: success()
        run: |
          command -v xmllint &> /dev/null || { echo "[ERROR] xmllint not found"; exit 1; }
          command -v bc &> /dev/null || { echo "[ERROR] bc not found"; exit 1; }
          
          COVERAGE=$(find ./TestResults -name 'coverage.cobertura.xml' -exec xmllint --xpath 'string(//coverage/@line-rate)' {} \; 2>/dev/null | head -1)
          [ -z "$COVERAGE" ] && { echo "[ERROR] Could not parse coverage report"; exit 1; }
          
          COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc)
          echo "[INFO] Code coverage: ${COVERAGE_PCT}%"
          
          (( $(echo "$COVERAGE < 0.80" | bc -l) )) && {
            echo "[ERROR] Coverage ${COVERAGE_PCT}% is below 80% threshold"
            exit 1
          }

      - name: Comment on issue
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: '[ERROR] Claude encountered an error implementing this issue. Please review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
